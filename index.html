<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Thời gian biểu cho bé</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&display=swap" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
    <link href="css/main.css" rel="stylesheet"/>
    
    <!-- Thêm CSS cho profile, cây và các phần thiếu -->
    <style>
        :root {
            --primary-color: #FF7043;
            --accent-color: #4CAF50;
            --bg-color: #2D2424;
            --task-bg: #1E1919;
            --text-color: #ffffff;
            --btn-good: #1B4332;
            --btn-neutral: #8B7355;
            --btn-bad: #7B1818;
            --highlight-color: #FFEB3B;
        }

        body {
            background-image: url('images/hinhnen.jpg');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            font-family: 'Baloo 2', cursive;
            color: var(--text-color);
            margin: 0;
            padding: 0;
            position: relative;
        }

        /* Add overlay to improve text readability on the background image */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(45, 36, 36, 0.7);
            z-index: -1;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        
        /* Cải thiện header */
        .header {
            text-align: center;
            padding: 10px 0;
            position: relative;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin: 10px 0 5px;
            background: linear-gradient(45deg, #FF7043, #FF9800);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0px 2px 4px rgba(0,0,0,0.3);
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        /* CSS cho thử thách tuần mới - nhỏ lại và xinh hơn */
        .weekly-challenge-container {
            background: linear-gradient(135deg, #6200ea, #3f51b5);
            color: white;
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            border-left: 3px solid #FFEB3B;
        }

        .weekly-challenge-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            opacity: 0.5;
            animation: shineBg 3s infinite linear;
            pointer-events: none;
        }

        .weekly-challenge-container h3 {
            color: #FFEB3B;
            font-size: 1.2em;
            margin-top: 0;
            margin-bottom: 5px;
            position: relative;
            display: inline-block;
        }

        .challenge-description {
            font-size: 1em;
            margin: 8px 0;
        }

        .progress-bar {
            height: 8px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFEB3B, #FFC107);
            border-radius: 10px;
            width: 0%;
            transition: width 1s ease;
        }

        #challenge-progress-text {
            font-weight: bold;
            color: white;
            font-size: 0.9em;
            margin: 3px 0;
        }

        .challenge-reward {
            background: rgba(255,255,255,0.15);
            padding: 5px 10px;
            border-radius: 8px;
            margin-top: 8px;
            display: inline-block;
            font-size: 0.9em;
        }

        #reward-icon {
            font-size: 1.2em;
            animation: bounce 1s infinite alternate;
        }
        
        /* Thi đua tuần này */
        .weekly-competition {
            background: linear-gradient(135deg, #212121, #424242);
            color: white;
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .weekly-competition h3 {
            color: #FFC107;
            font-size: 1.2em;
            margin-top: 0;
            margin-bottom: 15px;
            position: relative;
            display: inline-block;
        }
        
        .competition-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .competitor {
            text-align: center;
            flex: 1;
        }
        
        .competitor-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #FF7043;
            object-fit: cover;
            position: relative;
        }
        
        .competitor-level {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #FF7043;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .competitor-score {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0 5px;
        }
        
        .score-bar {
            height: 5px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            margin-top: 5px;
            position: relative;
        }
        
        .score-fill {
            height: 100%;
            background: #FF7043;
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .vs-label {
            font-size: 24px;
            font-weight: bold;
            color: #FF5722;
        }
        
        /* CSS cho nút đánh giá - icon to hơn */
        @media screen and (max-width: 768px) {
            .rating-btn {
                padding: 15px 5px;
                min-height: 70px;
            }
            
            .rating-btn i {
                font-size: 28px;
                margin-bottom: 8px;
            }
            
            .task-header {
                padding: 10px;
            }
            
            .task-time {
                font-size: 16px;
                font-weight: bold;
            }
            
            .task-name {
                font-size: 16px;
            }
        }

        /* CSS cho profile container cải tiến - hình đại diện to hơn ở giữa */
        .profile-container {
            text-align: center;
            padding: 15px 10px 10px;
            background: transparent; /* Bỏ background đen */
            border-radius: 0;
            margin-bottom: 0;
            z-index: 1000;
        }

        .profile-container img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #FF7043;
            margin-bottom: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3); /* Thêm bóng để ảnh nổi bật trên nền */
        }

        .profile-info {
            text-align: center;
        }

        .profile-name {
            font-weight: bold;
            color: #FF7043; 
            font-size: 18px;
            margin-bottom: 2px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8); /* Thêm bóng chữ để dễ đọc */
        }

        .profile-level {
            font-size: 14px;
            color: white; /* Đổi màu cho dễ đọc trên background */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8); /* Thêm bóng chữ */
        }
        
        .xp-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin: 5px auto;
            width: 80%;
            max-width: 200px;
            overflow: hidden;
        }
        
        .xp-progress {
            height: 100%;
            background: linear-gradient(90deg, #FF7043, #FF9800);
            border-radius: 3px;
            width: 0%;
        }
        
        /* CSS cho tab cải tiến */
        .tabs {
            display: flex;
            justify-content: center;
            border-radius: 10px;
            overflow: hidden;
            margin: 0;
        }
        
        .tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .tab img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
            border: 1px solid white;
        }
        
        .tab.active {
            background: var(--primary-color);
            font-weight: bold;
        }
        
        /* Thứ ngày style đẹp hơn */
        .date-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            background: rgba(187, 1, 1, 0.2);
            border-radius: 20px;
            padding: 8px 15px;
            width: 100%; /* Kéo dài khung ra */
            max-width: 570px; /* Giới hạn chiều rộng tối đa */
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            margin-left: auto;
            margin-right: auto;
        }
        
        .date-nav-button {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 18px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .date-nav-button:hover {
            background: rgba(255,255,255,0.2);
        }
        
        #current-date {
            flex: 1;
            text-align: center;
        }
        
        .current-time {
            color: #FFC107;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* Cài đặt chung */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* CSS cho thử thách tuần mới */
        .weekly-challenge-container {
            background: linear-gradient(135deg, #6200ea, #3f51b5);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            border-left: 5px solid #FFEB3B;
            animation: pulse 2s infinite alternate;
        }

        .weekly-challenge-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            opacity: 0.5;
            animation: shineBg 3s infinite linear;
            pointer-events: none;
        }

        @keyframes shineBg {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
            100% { box-shadow: 0 4px 20px rgba(98,0,234,0.6); }
        }

        .weekly-challenge-container h3 {
            color: #FFEB3B;
            font-size: 1.4em;
            margin-top: 0;
            position: relative;
            display: inline-block;
        }

        .weekly-challenge-container h3::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(255,255,255,0.5);
        }

        .challenge-description {
            font-size: 1.1em;
            margin: 15px 0;
            font-weight: 500;
        }

        .progress-bar {
            height: 10px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFEB3B, #FFC107);
            border-radius: 10px;
            width: 0%;
            transition: width 1s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        #challenge-progress-text {
            font-weight: bold;
            color: white;
            font-size: 1.1em;
            margin: 5px 0;
        }

        .challenge-reward {
            background: rgba(255,255,255,0.15);
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: inline-block;
        }

        #reward-icon {
            font-size: 1.5em;
            animation: bounce 1s infinite alternate;
        }

        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-5px); }
        }

        /* CSS cho nút đánh giá trên mobile - 1 hàng */
        @media screen and (max-width: 768px) {
            .rating-buttons {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                gap: 8px;
                margin-top: 15px;
            }

            .rating-btn {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 12px 5px;
                font-size: 13px;
                text-align: center;
                border-radius: 10px;
                min-height: 60px;
                transition: transform 0.2s, box-shadow 0.2s;
            }
            
            .rating-btn i {
                font-size: 20px;
                margin-bottom: 5px;
            }
            
            .rating-btn.active {
                transform: scale(1.05);
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            }
            
            .good-btn {
                background: linear-gradient(145deg, #1B4332, #2E7D32);
            }
            
            .neutral-btn {
                background: linear-gradient(145deg, #8B7355, #A1887F);
            }
            
            .bad-btn {
                background: linear-gradient(145deg, #7B1818, #B71C1C);
            }

            /* Điều chỉnh khoảng cách giữa cây và nút */
            .tree-container {
                margin-top: 30px;
                margin-bottom: 30px;
            }
            
            /* Cải thiện hiển thị animation tưới nước */
            #watering-gif {
                top: 40%;
            }
        }

        /* CSS cho cây và animation */
        .tree-container {
            position: relative;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .tree-image {
            width: 180px;
            height: 180px;
            transition: all 0.3s ease;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
        }

        .tree-growth {
            animation: treeGrow 1s ease-out;
        }

        @keyframes treeGrow {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        /* CSS cho nút tưới nước */
        .water-button {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1976D2, #03A9F4);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: waterPulse 1.5s infinite alternate;
        }

        .water-button:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        @keyframes waterPulse {
            0% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.6); }
            70% { box-shadow: 0 0 0 15px rgba(33, 150, 243, 0); }
            100% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0); }
        }
        
        /* CSS cho phần thống kê */
        .stats-container {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: #FFEB3B;
        }
        
        .stats-header h3 {
            margin: 0;
            font-size: 1.2em;
        }
        
        .stats-body {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 10px;
        }
        
        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .stats-row:last-child {
            border-bottom: none;
        }
        
        .stats-label {
            font-weight: bold;
        }
        
        .stats-value {
            color: var(--primary-color);
        }
        
        .stats-child-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .stats-child-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background: rgba(0,0,0,0.3);
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .stats-child-btn.active {
            background: var(--primary-color);
            font-weight: bold;
        }

        /* CSS cho popup thời gian tùy chỉnh */
        .time-settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .time-settings-container {
            background: #2D2424;
            width: 90%;
            max-width: 400px;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: scaleIn 0.3s forwards;
        }

        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .time-settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 10px;
        }

        .time-settings-header h3 {
            margin: 0;
            color: var(--primary-color);
        }

        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .time-settings-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .time-item {
            margin-bottom: 15px;
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
        }

        .time-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .time-input {
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 5px;
        }

        .save-times-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            width: 100%;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            margin-top: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .save-times-button:hover {
            background: #E65100;
        }

        /* CSS cho profile container cải tiến */
        .profile-container {
            position: sticky;
            top: 0;
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: transparent;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            z-index: 1000;
        }

        .profile-container img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #FF7043;
        }

        .profile-info {
            margin-left: 10px;
            flex: 1;
        }

        .profile-name {
            font-weight: bold;
            color: #FF7043;
            font-size: 14px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        }

        .profile-level {
            font-size: 12px;
            color: #ffffff;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8); 
        }
        
        /* CSS cho tab nhỏ hơn */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .tab {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
            border: 1px solid white;
        }
        
        .tab.active {
            background: var(--primary-color);
        }
        
        /* CSS cho cây lớn hơn và vị trí nút tưới nước */
        .tree-container {
            position: relative;
            padding: 20px;
            text-align: center;
            margin: 30px 0;
        }

        .tree-image {
            width: 240px;
            height: 240px;
            transition: all 0.3s ease;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
        }
        
        /* Điều chỉnh vị trí nút tưới nước sang bên phải */
        .water-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
        }
        
        /* Cập nhật vị trí hiệu ứng tưới nước */
        #watering-gif {
            position: absolute;
            width: 80px;
            height: 120px;
            top: 40%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        
        /* CSS cho popup chúc mừng */
        #popup-congrats img {
            width: 120px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        
        /* CSS cho thống kê thu gọn */
        .stats-container {
            position: relative;
        }
        
        .stats-toggle-button {
            position: absolute;
            top: -5px;
            right: 0;
            background: var(--primary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
        }
        
        .stats-content {
            display: none;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* CSS cho điều hướng ngày */
        .date-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 5px 0;
        }
        
        .date-nav-button {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .current-time {
            margin-top: 5px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Responsive CSS */
        @media screen and (max-width: 768px) {
            .profile-container {
                padding: 5px 8px;
            }
            
            .profile-container img {
                width: 35px;
                height: 35px;
            }
            
            .tab img {
                width: 25px;
                height: 25px;
            }
            
            .tree-image {
                width: 200px;
                height: 200px;
            }
            
            .water-button {
                width: 50px;
                height: 50px;
                right: 5px;
            }
        }

        /* CSS cho hiệu ứng pháo hoa khi vote good */
        .fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        
        .firework {
            position: absolute;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            animation: firework-core 3s forwards;
        }
        
        .firework-ray {
            position: absolute;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        
        @keyframes firework-core {
            0% { transform: translate(-50%, -50%) scale(0.1); opacity: 1; }
            5% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            10% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.2; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        
        /* CSS cho hệ thống cấp độ */
        .level-up-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #8A2387, #E94057, #F27121);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            z-index: 10000;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            max-width: 300px;
            animation: levelUpPop 0.5s ease-out forwards;
        }
        
        @keyframes levelUpPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            70% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .level-up-notification h2 {
            color: #FFEB3B;
            margin: 10px 0;
        }
        
        .level-up-notification .level {
            font-size: 2.5em;
            font-weight: bold;
            color: #FFEB3B;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        .level-up-notification .message {
            font-size: 0.9em;
            margin-top: 15px;
        }
        
        .level-up-notification .close-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            margin-top: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .level-up-notification .close-button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* CSS cho hệ thống đề xuất mục tiêu */
        .goal-suggestion {
            background: linear-gradient(135deg, #2980b9, #2c3e50);
            margin: 15px 0;
            padding: 15px;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            border-left: 3px solid #3498db;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .goal-suggestion h3 {
            color: #3498db;
            margin-top: 0;
            font-size: 1.2em;
        }
        
        .goal-description {
            margin: 10px 0;
        }
        
        .goal-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .goal-actions button {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .goal-actions button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .goal-actions .accept-goal {
            background: #2ecc71;
        }
        
        .goal-actions .decline-goal {
            background: rgba(255,255,255,0.1);
        }
        
        /* CSS cho biểu tượng cây và modal */
        .tree-icon-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.3s, box-shadow 0.3s;
            z-index: 1000;
        }
        
        .tree-icon-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
            animation: pulse 2s infinite alternate;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
            100% { box-shadow: 0 4px 20px rgba(76, 175, 80, 0.6); }
        }
        
        .tree-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .tree-modal.active {
            display: flex;
        }
        
        .tree-modal-content {
            background: #2D2424;
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: scaleIn 0.3s forwards;
        }
        
        .tree-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 10px;
        }
        
        .tree-modal-header h2 {
            margin: 0;
            color: var(--primary-color);
        }
        
        .tree-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .tree-display {
            text-align: center;
        }
        
        .tree-info {
            margin-top: 20px;
        }
        
        .points {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .level {
            font-size: 1.1em;
            color: #FFEB3B;
            margin-top: 5px;
        }
        
        .progress-to-next-level {
            margin-top: 10px;
        }
        
        .level-bar {
            height: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .level-progress {
            height: 100%;
            background: linear-gradient(90deg, #FFEB3B, #FFC107);
            border-radius: 10px;
            width: 0%;
            transition: width 1s ease;
        }
        
        .level-markers {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: rgba(255,255,255,0.5);
            margin-top: 5px;
        }

        /* CSS cho các khối nội dung (làm trong suốt để thấy hình nền) */
        .weekly-challenge-container, .weekly-competition, .task, .stats-container, .tree-modal-content, .level-up-notification {
            background-color: rgba(33, 33, 33, 0.7) !important; /* Màu nền tối với độ trong suốt */
            backdrop-filter: blur(5px); /* Hiệu ứng mờ phía sau */
            -webkit-backdrop-filter: blur(5px); /* Hỗ trợ Safari */
            border: 1px solid rgba(255, 255, 255, 0.1); /* Viền mỏng */
        }
        
        /* CSS cho thử thách tuần mới */
        .weekly-challenge-container {
            background: linear-gradient(135deg, rgba(98, 0, 234, 0.7), rgba(63, 81, 181, 0.7)) !important;
            border-left: 5px solid #FFEB3B;
        }
        
        /* CSS cho thi đua tuần này */
        .weekly-competition {
            background: linear-gradient(135deg, rgba(33, 33, 33, 0.7), rgba(66, 66, 66, 0.7)) !important;
        }
        
        /* Tối ưu hóa giao diện cho thiết bị di động */
        @media screen and (max-width: 576px) {
            body {
                /* Đảm bảo hình nền hiển thị tốt trên thiết bị nhỏ */
                background-position: center center;
                background-size: cover;
                background-attachment: fixed;
            }
            
            /* Tăng kích thước font chữ cho dễ đọc */
            .task-time {
                font-size: 18px !important;
                font-weight: bold;
            }
            
            .task-name {
                font-size: 16px !important;
            }
            
            .rating-btn {
                padding: 12px 5px !important;
                font-size: 14px !important;
            }
            
            /* Cây chiếm ít không gian hơn trên màn hình nhỏ */
            .tree-image {
                width: 180px !important;
                height: 180px !important;
            }
            
            /* Điều chỉnh kích thước ảnh đại diện */
            .profile-container img {
                width: 100px !important;
                height: 100px !important;
            }
            
            /* Điều chỉnh tiêu đề cho vừa màn hình */
            .header h1 {
                font-size: 1.5rem !important;
            }
        }
        
        /* CSS cho giao diện mobile */
        @media screen and (max-width: 480px) {
            /* Điều chỉnh các nút đánh giá */
            .rating-buttons {
                display: flex;
                flex-wrap: wrap;
            }
            
            .rating-btn {
                flex: 0 0 100%; /* Mỗi nút chiếm một hàng */
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Thêm profile của 2 em -->
    <div class="profile-container" id="tridung-profile">
        <img src="images/vit.jpg" alt="Trí Dũng" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #FF7043; box-shadow: 0 3px 10px rgba(0,0,0,0.3);">
        <div class="profile-info" style="margin-left: 15px; text-align: left;">
            <div class="profile-name" style="font-weight: bold; color: #FF7043; font-size: 18px; margin-bottom: 5px; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">Trí Dũng</div>
            <div class="profile-level" style="font-size: 16px; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">Cấp <span id="tridung-level">1</span></div>
            <div class="xp-bar">
                <div class="xp-progress" id="tridung-xp-progress" style="width: 0%"></div>
            </div>
        </div>
        <button onclick="openTimeSettings('tridung')" class="time-settings-button" style="background: none; border: none; color: var(--primary-color); position: absolute; right: 10px; top: 10px;">
            <i class="fas fa-clock"></i>
        </button>
    </div>

    <div class="profile-container" id="thaoVy-profile" style="display: none;">
        <img src="images/vy.jpg" alt="Thảo Vy" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #FF7043; box-shadow: 0 3px 10px rgba(0,0,0,0.3);">
        <div class="profile-info" style="margin-left: 15px; text-align: left;">
            <div class="profile-name" style="font-weight: bold; color: #FF7043; font-size: 18px; margin-bottom: 5px; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">Thảo Vy</div>
            <div class="profile-level" style="font-size: 16px; color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">Cấp <span id="thaoVy-level">1</span></div>
            <div class="xp-bar">
                <div class="xp-progress" id="thaoVy-xp-progress" style="width: 0%"></div>
            </div>
        </div>
        <button onclick="openTimeSettings('thaoVy')" class="time-settings-button" style="background: none; border: none; color: var(--primary-color); position: absolute; right: 10px; top: 10px;">
            <i class="fas fa-clock"></i>
        </button>
    </div>

    <div class="container">
        <div class="header">
            <h1>Thời gian biểu cho bé</h1>
            
            <!-- Thêm điều hướng ngày -->
            <div class="date-navigation">
                <button class="date-nav-button" onclick="navigateDate(-1)" title="Ngày trước đó">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="current-date">
                    <span class="current-time"></span>
                </div>
                <button class="date-nav-button" onclick="navigateDate(1)" title="Ngày tiếp theo">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-child="tridung">
                <img src="images/vit.jpg" alt="Trí Dũng">
                Trí Dũng (5 tuổi)
            </div>
            <div class="tab" data-child="thaoVy">
                <img src="images/vy.jpg" alt="Thảo Vy">
                Thảo Vy (3 tuổi)
            </div>
        </div>

        <!-- Thi đua tuần này - Đặt lên trên thử thách tuần -->
        <div class="weekly-competition">
            <h3><i class="fas fa-medal"></i> Thi đua tuần này</h3>
            <div class="competition-content">
                <div class="competitor">
                    <div style="position: relative; display: inline-block;">
                        <img src="images/vit.jpg" class="competitor-img" alt="Trí Dũng">
                        <div class="competitor-level" id="competition-tridung-level">1</div>
                    </div>
                    <div class="competitor-score" id="competition-tridung-score">0</div>
                    <div class="score-bar">
                        <div class="score-fill" id="competition-tridung-bar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="vs-label">VS</div>
                
                <div class="competitor">
                    <div style="position: relative; display: inline-block;">
                        <img src="images/vy.jpg" class="competitor-img" alt="Thảo Vy">
                        <div class="competitor-level" id="competition-thaoVy-level">1</div>
                    </div>
                    <div class="competitor-score" id="competition-thaoVy-score">0</div>
                    <div class="score-bar">
                        <div class="score-fill" id="competition-thaoVy-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Thử thách tuần này - Di chuyển xuống dưới thi đua -->
        <div class="weekly-challenge-container">
            <h3><i class="fas fa-trophy"></i> Thử thách tuần này</h3>
            <div class="challenge-description" id="current-challenge">
                Hoàn thành <strong>3 nhiệm vụ</strong> Đi ngủ đúng giờ liên tiếp!
            </div>
            <div class="challenge-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="challenge-progress-fill" style="width: 0%"></div>
                </div>
                <div id="challenge-progress-text">0/3</div>
            </div>
            <div class="challenge-reward">
                <span id="reward-icon">🎁</span> Phần thưởng: <span id="challenge-reward">2 lượt tưới nước đặc biệt!</span>
            </div>
        </div>

        <div id="tridung" class="child-content">
            <div class="task-list"></div>
        </div>

        <div id="thaoVy" class="child-content" style="display: none;">
            <div class="task-list"></div>
        </div>
    
        <!-- Biểu tượng cây khi click vào sẽ hiển thị modal cây -->
        <div class="tree-icon-button" id="tree-icon">
            <i class="fas fa-tree"></i>
        </div>
        
        <!-- Thống kê kết quả thu gọn -->
        <div class="stats-container">
            <button onclick="toggleStatsView()" class="stats-toggle-button" title="Xem thống kê">
                <i class="fas fa-chart-bar"></i>
            </button>
            
            <div id="stats-content" class="stats-content">
                <div class="stats-header">
                    <h3>Thống kê tuần này</h3>
                </div>
                
                <div class="stats-child-toggle">
                    <button class="stats-child-btn active" onclick="switchStatsChild('tridung')">Trí Dũng</button>
                    <button class="stats-child-btn" onclick="switchStatsChild('thaoVy')">Thảo Vy</button>
                </div>
                
                <div class="stats-body">
                    <div class="stats-row">
                        <div class="stats-label">Tốt:</div>
                        <div class="stats-value" id="stats-good">0</div>
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Chấp nhận được:</div>
                        <div class="stats-value" id="stats-neutral">0</div>
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Chưa tốt:</div>
                        <div class="stats-value" id="stats-bad">0</div>
                    </div>
                    <div class="stats-row">
                        <div class="stats-label">Độ tuân thủ:</div>
                        <div class="stats-value" id="stats-compliance">0%</div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Admin Controls Button -->
        <div id="admin-toggle" title="Cài đặt quản trị">⚙️</div>
    
        <!-- Admin Panel -->
        <div id="admin-panel" style="display: none;">
            <div class="admin-header">
                <h4>Quản lý hệ thống</h4>
                <button class="btn-close" id="close-admin">×</button>
            </div>
            <div class="admin-controls">
                <button class="admin-btn" id="reset-day" onclick="resetTree()">Đặt lại cây</button>
                <button class="admin-btn" id="add-water" onclick="addWaterCredits(1)">Thêm 1 lượt tưới</button>
                <button class="admin-btn" id="trigger-fireworks" onclick="createFireworks()">Hiệu ứng pháo hoa</button>
                <button class="admin-btn" id="reset-stats" onclick="resetWeeklyStats()">Đặt lại thống kê</button>
            </div>
        </div>
    
        <!-- Popup chúc mừng -->
        <div id="popup-congrats" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%, -50%); z-index:9999; text-align:center;">
            <img alt="Mẹ Quỳnh" src="images/me_quynh.jpg"/>
            <div id="popup-text">Bé làm tốt lắm!</div>
        </div>
        
        <!-- Dialog chỉnh thời gian -->
        <div class="time-settings-overlay" id="time-settings">
            <div class="time-settings-container">
                <div class="time-settings-header">
                    <h3>Điều chỉnh thời gian</h3>
                    <button class="close-button" onclick="closeTimeSettings()">×</button>
                </div>
                <div class="time-settings-body" id="time-settings-body">
                    <!-- Nội dung sẽ được tạo bằng JavaScript -->
                </div>
                <button class="save-times-button" onclick="saveTimeSettings()">Lưu thay đổi</button>
            </div>
        </div>

        <!-- Modal hiển thị cây -->
        <div class="tree-modal" id="tree-modal">
            <div class="tree-modal-content">
                <div class="tree-modal-header">
                    <h2 id="tree-name" style="margin: 0; color: #FF7043; font-size: 18px; font-weight: bold;">
                        Cây của bé Trí Dũng
                    </h2>
                    <button class="tree-modal-close" id="close-tree-modal">&times;</button>
                </div>
                <div class="tree-display" style="text-align: center;">
                    <!-- Cây và giọt nước: xếp ngang, cây ở giữa, nút nước riêng biệt bên phải -->
                    <div class="tree-container" style="display: flex; align-items: center; justify-content: space-between; position: relative;">
                        <!-- Ảnh cây ở giữa với margin bên trái để cân đối -->
                        <div style="flex: 1;"></div>
                        <img id="tree-img" src="images/tree_day1.png" class="tree-image"
                             alt="Cây phát triển"
                             style="width: 300px; height: 300px;"/>
                        
                        <!-- Giọt nước riêng biệt bên phải -->
                        <div style="flex: 1; display: flex; justify-content: center; margin-left: 15px;">
                            <button class="water-button" onclick="waterTree()" title="Tưới nước cho cây"
                                style="position: static; width: 60px; height: 60px; font-size: 30px;">
                                💧
                            </button>
                        </div>
                        
                        <!-- Hiệu ứng tưới nước ở giữa ảnh cây -->
                        <img id="watering-gif" src="images/water.gif"
                             style="display:none; position:absolute; width: 100px; height: 140px; top: 40%; left: 50%; transform: translateX(-50%); z-index: 10;"/>
                    </div>
                
                    <!-- Thông tin cấp và lượt tưới nước (bỏ điểm) -->
                    <div class="tree-info" style="margin-top: 20px; line-height: 1.6; clear: both;">
                        <div id="tree-status" style="font-weight:bold; color:#4CAF50; margin:5px 0;">
                            Cây đã phát triển hoàn toàn!
                        </div>
                        <div class="level" style="font-size: 18px; color: #FFEB3B; font-weight: bold; margin-top: 5px;">
                            Cấp <span id="tree-level-display">7</span>
                        </div>
                        <div class="progress-to-next-level">
                            <div class="level-bar">
                                <div class="level-progress" id="tree-level-progress" style="width: 0%"></div>
                            </div>
                            <div class="level-markers">
                                <span>0%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <audio id="audio-congrats" preload="auto" src=""></audio>
    </div>

    <script>
        // Hàm phát âm thanh cải tiến
        function playAudio(filename) {
            console.log("Đang phát âm thanh:", filename);
            const audio = new Audio(`audio/${filename}`);
            
            // Thêm hàm xử lý lỗi và thông báo
            audio.onloadeddata = function() {
                console.log("Âm thanh đã được tải:", filename);
            };
            
            audio.onerror = function(e) {
                console.error("Lỗi tải âm thanh:", e);
                alert("Không thể phát âm thanh. Vui lòng kiểm tra kết nối mạng hoặc thiết bị của bạn.");
            };
            
            // Phát âm thanh với xử lý lỗi
            const playPromise = audio.play();
            
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        console.log("Âm thanh đang phát:", filename);
                    })
                    .catch(error => {
                        console.warn("Không thể phát âm thanh:", error);
                        // Thông báo cho người dùng biết cần tương tác với trang
                        if (error.name === "NotAllowedError") {
                            alert("Vui lòng nhấp vào bất kỳ vị trí nào trên trang để cho phép phát âm thanh.");
                        }
                    });
            }
            
            return audio;
        }

        // Nhiệm vụ của mỗi em với thời gian tùy chỉnh
        const tasks = {
            tridung: [
                { id: 'td1', time: '06:00', name: 'Thức dậy, vệ sinh cá nhân & đi học', audio: 'thuc_day_ve_sinh_ca_nhan_di_hoc.mp3' },
                { id: 'td2', time: '17:00', name: 'Đọc sách, tô màu hoặc làm toán', audio: 'doc_sach_to_mau_hoac_lam_toan.mp3' },
                { id: 'td3', time: '18:00', name: 'Chơi tự do', audio: 'choi_tu_do.mp3' },
                { id: 'td4', time: '19:00', name: 'Ăn tối tại nhà', audio: 'an_toi_tai_nha.mp3' },
                { id: 'td5', time: '20:00', name: 'Vệ sinh cá nhân buổi tối', audio: 've_sinh_ca_nhan_buoi_toi.mp3' },
                { id: 'td6', time: '21:00', name: 'Đi ngủ', audio: 'di_ngu.mp3' }
            ],
            thaoVy: [
                { id: 'tv1', time: '06:00', name: 'Thức dậy, vệ sinh cá nhân & đi học', audio: 'thuc_day_ve_sinh_ca_nhan_di_hoc_thaovy.mp3' },
                { id: 'tv2', time: '17:00', name: 'Đọc sách, tô màu hoặc làm toán', audio: 'doc_sach_to_mau_hoac_lam_toan_thaovy.mp3' },
                { id: 'tv3', time: '18:00', name: 'Chơi tự do', audio: 'choi_tu_do_thaovy.mp3' },
                { id: 'tv4', time: '19:00', name: 'Ăn tối tại nhà', audio: 'an_toi_tai_nha_thaovy.mp3' },
                { id: 'tv5', time: '20:00', name: 'Vệ sinh cá nhân buổi tối', audio: 've_sinh_ca_nhan_buoi_toi_thaovy.mp3' },
                { id: 'tv6', time: '21:00', name: 'Đi ngủ', audio: 'di_ngu_thaovy.mp3' }
            ]
        };

        // Biến cho hệ thống cây phát triển
        let treeLevel = 1;
        let waterCredits = 0;
        let currentChild = 'tridung';
        let currentWeekDay = 0; // 0: Chủ Nhật, 1: Thứ 2...
        let currentStatsChild = 'tridung';
        
        // Biến lưu trữ thống kê hàng tuần
        let weeklyStats = {
            tridung: { good: 0, neutral: 0, bad: 0 },
            thaoVy: { good: 0, neutral: 0, bad: 0 }
        };
        
        // Hệ thống tính điểm
        const POINTS = {
            good: 3,
            neutral: 1,
            bad: 0
        };

        // Đánh giá nhiệm vụ và cập nhật thống kê
        function rateTask(childName, taskId, rating) {
            // Format ngày đang xem để lưu đánh giá
            const dateString = viewDate.toISOString().split('T')[0];
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            // Kiểm tra không cho đánh giá nhiệm vụ trong tương lai
            if (dateString > today) {
                alert("Không thể đánh giá nhiệm vụ trong tương lai!");
                return;
            }
            
            // Nếu là ngày hiện tại, kiểm tra không cho đánh giá nhiệm vụ chưa đến giờ
            if (dateString === today) {
                const task = tasks[childName].find(t => t.id === taskId);
                if (task) {
                    const currentHour = now.getHours();
                    const currentMinute = now.getMinutes();
                    const taskHour = parseInt(task.time.split(':')[0]);
                    const taskMinute = parseInt(task.time.split(':')[1]);
                    
                    // Nếu thời gian hiện tại chưa đến giờ của nhiệm vụ
                    if (currentHour < taskHour || (currentHour === taskHour && currentMinute < taskMinute)) {
                        alert(`Chưa đến giờ thực hiện nhiệm vụ "${task.name}" (${task.time})!`);
                        return;
                    }
                }
            }
            
            // Kiểm tra mật khẩu nếu không phải là môi trường phát triển
            if (!window.location.hostname.includes('localhost') && !window.location.hostname.includes('127.0.0.1')) {
                const pin = prompt("Nhập mã PIN để xác nhận (****)");
                if (pin !== "2022") {
                    alert("Mã PIN không đúng!");
                    return;
                }
            }
            
            // Lưu đánh giá cho ngày đang xem
            let childData = JSON.parse(localStorage.getItem(`${childName}Data`) || '{}');
            if (!childData.tasks) childData.tasks = {};
            if (!childData.tasks[dateString]) childData.tasks[dateString] = {};
            
            // Cập nhật đánh giá và thống kê
            const previousRating = childData.tasks[dateString][taskId];
            childData.tasks[dateString][taskId] = rating;
            
            // Xử lý thống kê tuần nếu đang xem ngày hiện tại
            if (dateOffset === 0) {
                updateWeeklyStats(childName, rating, previousRating);
            }
            
            // Tính điểm và cập nhật cấp độ
            let pointsEarned = 0;
            
            if (rating === 'good') {
                // Thêm điểm cho đánh giá tốt
                pointsEarned = POINTS.good;
                
                // Thêm lượt tưới nước nếu đang xem ngày hiện tại
                if (dateOffset === 0) {
                    addWaterCredits(1);
                    
                    // Tạo hiệu ứng pháo hoa khi được vote good
                    createFireworks();
                }
                
                // Phát âm thanh khen ngợi
                const task = tasks[childName].find(t => t.id === taskId);
                if (task && task.audio) {
                    playAudio(task.audio);
                }
                
                // Hiển thị popup chúc mừng nếu đang xem ngày hiện tại
                if (dateOffset === 0) {
                    showCongratulation(task.name, childName);
                }
            } else if (rating === 'neutral') {
                // Thêm điểm cho đánh giá trung bình
                pointsEarned = POINTS.neutral;
                
                // Phát âm thanh "cố gắng"
                playAudio("ban_co_gang_vao_lan_sau_nhe.mp3");
            } else if (rating === 'bad') {
                // Phát âm thanh "chưa tốt"
                playAudio("chua_tot.mp3");
            }
            
            // Nếu đang xem ngày hiện tại, thêm điểm kinh nghiệm
            if (dateOffset === 0 && pointsEarned > 0) {
                addExperiencePoints(childName, pointsEarned);
            }
            
            // Lưu dữ liệu
            localStorage.setItem(`${childName}Data`, JSON.stringify(childData));
            
            // Cập nhật giao diện
            updateTaskDisplay();
            
            // Cập nhật hiển thị thống kê
            updateStatsDisplay();
            
            // Cập nhật tiến độ thử thách tuần nếu đây là nhiệm vụ đi ngủ
            if ((childName === 'tridung' && taskId === 'td6') || 
                (childName === 'thaoVy' && taskId === 'tv6')) {
                updateWeeklyChallengeProgress();
            }
            
            // Kiểm tra và cập nhật huy hiệu nếu đang xem ngày hiện tại
            if (dateOffset === 0) {
                checkBadges(childName);
            }
            
            // Cập nhật điểm thi đua
            updateCompetitionScores(childName, rating);
        }

        // Cập nhật thống kê tuần
        function updateWeeklyStats(childName, newRating, previousRating) {
            // Tải thống kê hiện tại
            loadWeeklyStats();
            
            // Nếu đã có đánh giá trước đó, trừ đi
            if (previousRating) {
                weeklyStats[childName][previousRating]--;
            }
            
            // Cập nhật đánh giá mới
            weeklyStats[childName][newRating]++;
            
            // Lưu lại thống kê
            saveWeeklyStats();
            
            // Cập nhật hiển thị
            updateStatsDisplay();
        }
        
        // Lưu thống kê tuần
        function saveWeeklyStats() {
            localStorage.setItem('weeklyStats', JSON.stringify(weeklyStats));
        }
        
        // Tải thống kê tuần
        function loadWeeklyStats() {
            const savedStats = localStorage.getItem('weeklyStats');
            if (savedStats) {
                weeklyStats = JSON.parse(savedStats);
                // Đảm bảo cả hai bé đều có dữ liệu
                if (!weeklyStats.tridung) {
                    weeklyStats.tridung = { good: 0, neutral: 0, bad: 0 };
                }
                if (!weeklyStats.thaoVy) {
                    weeklyStats.thaoVy = { good: 0, neutral: 0, bad: 0 };
                }
            } else {
                weeklyStats = {
                    tridung: { good: 0, neutral: 0, bad: 0 },
                    thaoVy: { good: 0, neutral: 0, bad: 0 }
                };
            }
        }
        
        // Đặt lại thống kê tuần (khi bắt đầu tuần mới)
        function resetWeeklyStats() {
            // Kiểm tra xác nhận
            const pin = prompt("Nhập mã PIN để xác nhận đặt lại thống kê (****)");
            if (pin !== "2022") {
                alert("Mã PIN không đúng!");
                return;
            }
            
            if (confirm("Bạn có chắc chắn muốn đặt lại thống kê tuần không?")) {
                weeklyStats = {
                    tridung: { good: 0, neutral: 0, bad: 0 },
                    thaoVy: { good: 0, neutral: 0, bad: 0 }
                };
                saveWeeklyStats();
                updateStatsDisplay();
                alert("Đã đặt lại thống kê tuần thành công!");
            }
        }
        
        // Cập nhật hiển thị thống kê
        function updateStatsDisplay() {
            const stats = weeklyStats[currentStatsChild];
            
            // Tổng số nhiệm vụ
            const total = stats.good + stats.neutral + stats.bad;
            
            // Hiển thị các giá trị
            document.getElementById('stats-good').textContent = stats.good;
            document.getElementById('stats-neutral').textContent = stats.neutral;
            document.getElementById('stats-bad').textContent = stats.bad;
            
            // Tính và hiển thị độ tuân thủ (tỷ lệ tốt + chấp nhận được)
            let complianceRate = 0;
            if (total > 0) {
                complianceRate = Math.round(((stats.good + stats.neutral) / total) * 100);
            }
            document.getElementById('stats-compliance').textContent = `${complianceRate}%`;
        }
        
        // Chuyển đổi bé trong thống kê
        function switchStatsChild(childName) {
            currentStatsChild = childName;
            
            // Cập nhật giao diện nút
            document.querySelectorAll('.stats-child-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.stats-child-btn[onclick="switchStatsChild('${childName}')"]`).classList.add('active');
            
            // Cập nhật hiển thị thống kê
            updateStatsDisplay();
        }
        
        // Mở dialog điều chỉnh thời gian
        function openTimeSettings(childName) {
            // Cập nhật nội dung dialog
            const settingsBody = document.getElementById('time-settings-body');
            settingsBody.innerHTML = '';
            
            const childTasks = tasks[childName];
            
            // Tạo các input điều chỉnh thời gian
            childTasks.forEach(task => {
                const timeItem = document.createElement('div');
                timeItem.className = 'time-item';
                timeItem.innerHTML = `
                    <div class="time-item-header">
                        <div class="time-name">${task.name}</div>
                    </div>
                    <input type="time" class="time-input" data-task-id="${task.id}" value="${task.time}" />
                `;
                settingsBody.appendChild(timeItem);
            });
            
            // Lưu trữ bé đang được điều chỉnh
            settingsBody.setAttribute('data-child', childName);
            
            // Hiển thị dialog
            document.getElementById('time-settings').style.display = 'flex';
        }
        
        // Đóng dialog điều chỉnh thời gian
        function closeTimeSettings() {
            document.getElementById('time-settings').style.display = 'none';
        }
        
        // Lưu thay đổi thời gian
        function saveTimeSettings() {
            const settingsBody = document.getElementById('time-settings-body');
            const childName = settingsBody.getAttribute('data-child');
            
            // Thu thập giá trị thời gian mới
            const timeInputs = settingsBody.querySelectorAll('.time-input');
            timeInputs.forEach(input => {
                const taskId = input.getAttribute('data-task-id');
                const newTime = input.value;
                
                // Tìm và cập nhật nhiệm vụ
                const taskIndex = tasks[childName].findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    tasks[childName][taskIndex].time = newTime;
                }
            });
            
            // Lưu thời gian mới vào localStorage
            localStorage.setItem('customTasks', JSON.stringify(tasks));
            
            // Cập nhật hiển thị
            updateTaskDisplay();
            
            // Đóng dialog
            closeTimeSettings();
            
            // Thông báo
            alert('Đã lưu thời gian mới thành công!');
        }

        // Hàm hiển thị nhiệm vụ với nút đánh giá trong một hàng
        function updateTaskDisplay() {
            const taskLists = document.querySelectorAll('.task-list');
            taskLists.forEach(list => {
                list.innerHTML = '';
            });
            
            // Format ngày theo chuẩn ISO để so sánh với dữ liệu lưu trữ
            const viewDateString = viewDate.toISOString().split('T')[0];
            
            // Hiển thị nhiệm vụ cho từng bé
            for (const childName in tasks) {
                const childData = JSON.parse(localStorage.getItem(`${childName}Data`) || '{}');
                const taskList = document.querySelector(`#${childName} .task-list`);
                
                if (!taskList) continue;
                
                tasks[childName].forEach(task => {
                    // Lấy đánh giá của ngày đang xem
                    const rating = childData.tasks && childData.tasks[viewDateString] ? 
                                   childData.tasks[viewDateString][task.id] : null;
                    
                    const taskElement = document.createElement('div');
                    taskElement.className = `task ${rating ? 'completed-' + rating : ''}`;
                    taskElement.innerHTML = `
                        <div class="task-header">
                            <div class="task-time">${task.time}</div>
                            <div class="task-name">${task.name}</div>
                        </div>
                        <div class="rating-buttons">
                            <button class="rating-btn good-btn ${rating === 'good' ? 'active' : ''}" 
                                    onclick="rateTask('${childName}', '${task.id}', 'good')">
                                <i class="fas fa-smile"></i> Tốt
                            </button>
                            <button class="rating-btn neutral-btn ${rating === 'neutral' ? 'active' : ''}" 
                                    onclick="rateTask('${childName}', '${task.id}', 'neutral')">
                                <i class="fas fa-meh"></i> Chấp nhận được
                            </button>
                            <button class="rating-btn bad-btn ${rating === 'bad' ? 'active' : ''}" 
                                    onclick="rateTask('${childName}', '${task.id}', 'bad')">
                                <i class="fas fa-frown"></i> Chưa tốt
                            </button>
                        </div>
                    `;
                    
                    taskList.appendChild(taskElement);
                });
            }
            
            // Cập nhật tiến độ thử thách tuần
            updateWeeklyChallengeProgress();
        }
        
        // Khởi tạo ứng dụng
        document.addEventListener('DOMContentLoaded', function() {
            // Tải thời gian tùy chỉnh từ localStorage
            const savedTasks = localStorage.getItem('customTasks');
            if (savedTasks) {
                const parsedTasks = JSON.parse(savedTasks);
                // Chỉ cập nhật nếu có dữ liệu hợp lệ
                if (parsedTasks.tridung && parsedTasks.tridung.length > 0 &&
                    parsedTasks.thaoVy && parsedTasks.thaoVy.length > 0) {
                    tasks.tridung = parsedTasks.tridung;
                    tasks.thaoVy = parsedTasks.thaoVy;
                }
            }
            
            // Tải dữ liệu thống kê
            loadWeeklyStats();
            
            // Tải dữ liệu cây
            loadData();
            
            // Cập nhật hiển thị ngày đang xem
            updateViewDateDisplay();
            
            // Cập nhật hiển thị nhiệm vụ
            updateTaskDisplay();
            
            // Cập nhật hiển thị thống kê
            updateStatsDisplay();
            
            // Cập nhật thời gian hiện tại
            updateCurrentTime();
            
            // Cập nhật thời gian mỗi phút
            setInterval(updateCurrentTime, 60000);
            
            // Thêm sự kiện cho các tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const childName = this.getAttribute('data-child');
                    switchTab(childName);
                });
            });
            
            // Sự kiện hiển thị/ẩn Admin Panel
            const adminToggle = document.getElementById('admin-toggle');
            const adminPanel = document.getElementById('admin-panel');
            const closeAdmin = document.getElementById('close-admin');
            
            if (adminToggle) {
                adminToggle.addEventListener('click', function() {
                    const pin = prompt("Nhập mã PIN để truy cập tính năng quản trị (****)");
                    if (pin === "2022") {
                        adminPanel.style.display = adminPanel.style.display === 'none' ? 'block' : 'none';
                    } else {
                        alert("Mã PIN không đúng!");
                    }
                });
            }
            
            if (closeAdmin) {
                closeAdmin.addEventListener('click', function() {
                    adminPanel.style.display = 'none';
                });
            }
            
            // Cập nhật số lượt tưới nước
            if (document.getElementById("water-units")) {
                document.getElementById("water-units").textContent = waterCredits || 0;
            }
            
            // Cập nhật tiến độ thử thách tuần
            updateWeeklyChallengeProgress();
            
            // Yêu cầu quyền thông báo khi trang web được tải
            requestNotificationPermission();
            
            // Cập nhật hiển thị cây
            updateTreeDisplay();
            
            // Cập nhật hiển thị lượt tưới nước
            if (document.getElementById('water-units')) {
                document.getElementById('water-units').textContent = waterCredits;
            }
            
            // Thêm sự kiện cho biểu tượng cây và nút đóng modal
            const treeIcon = document.getElementById('tree-icon');
            const treeModal = document.getElementById('tree-modal');
            const closeTreeModal = document.getElementById('close-tree-modal');
            
            if (treeIcon) {
                treeIcon.addEventListener('click', function() {
                    treeModal.classList.add('active');
                    // Cập nhật hiển thị cây khi mở modal
                    updateTreeDisplay();
                });
            }
            
            if (closeTreeModal) {
                closeTreeModal.addEventListener('click', function() {
                    treeModal.classList.remove('active');
                });
            }
            
            // Đóng modal khi click ra ngoài
            treeModal.addEventListener('click', function(e) {
                if (e.target === treeModal) {
                    treeModal.classList.remove('active');
                }
            });
            
            // Cập nhật hiển thị cây chỉ trong modal
            updateTreeDisplay();
        });

        // Các hàm khác vẫn giữ nguyên...

        // Hiển thị chúc mừng
        function showCongratulation(taskName, childName) {
            const popup = document.getElementById("popup-congrats");
            const popupText = document.getElementById("popup-text");
            
            // Hiển thị thông báo phù hợp với từng bé
            const childDisplayName = childName === 'thaoVy' ? 'Thảo Vy' : 'Trí Dũng';
            popupText.innerText = `Chúc mừng bé ${childDisplayName} hoàn thành tốt nhiệm vụ: ${taskName}`;
            popup.style.display = "block";
            
            // Tự động ẩn sau 3 giây
            setTimeout(() => {
                popup.style.display = "none";
            }, 3000);
        }

        // Hàm chuyển đổi tab
        function switchTab(childName) {
            currentChild = childName;
            
            // Cập nhật trạng thái tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`.tab[data-child="${childName}"]`).classList.add('active');
            
            // Hiển thị nội dung tương ứng
            document.querySelectorAll('.child-content').forEach(content => {
                content.style.display = 'none';
            });
            
            document.getElementById(childName).style.display = 'block';
            
            // Ẩn/hiện profile tương ứng
            document.getElementById('tridung-profile').style.display = childName === 'tridung' ? 'flex' : 'none';
            document.getElementById('thaoVy-profile').style.display = childName === 'thaoVy' ? 'flex' : 'none';
            
            // Cập nhật tên cây
            const treeName = document.getElementById('tree-name');
            if (treeName) {
                treeName.textContent = `Cây của bé ${childName === 'tridung' ? 'Trí Dũng' : 'Thảo Vy'}`;
            }
            
            // Cập nhật tiến độ thử thách tuần cho bé được chọn
            updateWeeklyChallengeProgress();
            
            // Cập nhật hiển thị thống kê
            updateStatsDisplay();
            
            // Cập nhật thông tin cây trong modal
            updateTreeDisplay();
        }

        // Hàm cập nhật thời gian hiện tại
        function updateCurrentTime() {
            const now = new Date();
            
            // Nếu đang xem ngày hiện tại, cập nhật viewDate
            if (dateOffset === 0) {
                viewDate = now;
                updateViewDateDisplay();
            }
            
            // Kiểm tra thông báo nhiệm vụ
            checkTaskNotifications();
        }

        // Các hàm còn lại giữ nguyên...

        // Hàm tải dữ liệu
        function loadData() {
            // Tải dữ liệu cây
            treeLevel = parseInt(localStorage.getItem('treeLevel') || '1');
            waterCredits = parseInt(localStorage.getItem('waterCredits') || '0');
            
            // Cập nhật hiển thị cây
            updateTreeDisplay();
            
            // Cập nhật hiển thị lượt tưới nước
            if (document.getElementById('water-units')) {
                document.getElementById('water-units').textContent = waterCredits;
            }
        }
        
        // Hàm lưu dữ liệu
        function saveData() {
            localStorage.setItem('treeLevel', treeLevel);
            localStorage.setItem('waterCredits', waterCredits);
        }
        
        // Hàm tưới nước cho cây
        function waterTree() {
            if (waterCredits <= 0) {
                alert("Bạn không có đủ lượt tưới nước. Hãy hoàn thành tốt nhiệm vụ để nhận thêm!");
                return;
            }
            
            // Giảm lượt tưới nước
            waterCredits--;
            
            // Hiển thị animation tưới nước
            const wateringGif = document.getElementById('watering-gif');
            if (wateringGif) {
                wateringGif.style.display = 'block';
                wateringGif.style.left = '50%';
                wateringGif.style.transform = 'translateX(-50%)';
                
                setTimeout(() => {
                    wateringGif.style.display = 'none';
                }, 2000);
            }
            
            // Tăng cấp độ cây nếu chưa đạt tối đa
            if (treeLevel < 7) {
                treeLevel++;
                
                // Hiển thị hiệu ứng phát triển
                const treeImg = document.getElementById('tree-img');
                if (treeImg) {
                    treeImg.classList.add('tree-growth');
                    setTimeout(() => {
                        treeImg.classList.remove('tree-growth');
                    }, 1000);
                }
                
                // Hiệu ứng phần thưởng khi cây đạt cấp độ cuối cùng
                if (treeLevel === 7) {
                    setTimeout(() => {
                        triggerFireworks();
                        playAudio('firework.mp3');
                        alert("Chúc mừng! Cây của bạn đã phát triển hoàn toàn!");
                    }, 2000);
                }
            }
            
            // Cập nhật hiển thị cây
            updateTreeDisplay();
            
            // Lưu dữ liệu
            saveData();
            
            // Cập nhật hiển thị lượt tưới nước
            if (document.getElementById('water-units')) {
                document.getElementById('water-units').textContent = waterCredits;
            }
        }
        
        // Hàm cập nhật hiển thị cây
        function updateTreeDisplay() {
            const treeImg = document.getElementById('tree-img');
            if (!treeImg) return;
            
            // Cập nhật hình ảnh cây theo cấp độ
            treeImg.src = `images/tree_day${treeLevel}.png`;
            
            // Cập nhật trạng thái cây
            const treeStatus = document.getElementById('tree-status');
            if (treeStatus) {
                if (treeLevel < 7) {
                    treeStatus.textContent = "Cây cần nước để phát triển!";
                    treeStatus.style.color = "#FFEB3B";
                } else {
                    treeStatus.textContent = "Cây đã phát triển hoàn toàn!";
                    treeStatus.style.color = "#4CAF50";
                }
            }
            
            // Cập nhật thông tin cấp độ trong modal
            const treeLevelDisplay = document.getElementById('tree-level-display');
            if (treeLevelDisplay) {
                treeLevelDisplay.textContent = treeLevel;
            }
            
            // Cập nhật tiến trình cấp độ
            const treeLevelProgress = document.getElementById('tree-level-progress');
            if (treeLevelProgress) {
                const progressPercent = ((treeLevel - 1) / 6) * 100;
                treeLevelProgress.style.width = `${progressPercent}%`;
            }
            
            // Cập nhật điểm trong modal
            const currentChild = document.querySelector('.tab.active').getAttribute('data-child');
            const childData = JSON.parse(localStorage.getItem(`${currentChild}Data`) || '{}');
            const points = childData.points || 0;
            
            const treePoints = document.getElementById('tree-points');
            if (treePoints) {
                treePoints.textContent = points;
            }
        }
        
        // Hàm thêm lượt tưới nước
        function addWaterCredits(amount) {
            waterCredits += amount;
            localStorage.setItem('waterCredits', waterCredits);
            
            if (document.getElementById('water-units')) {
                document.getElementById('water-units').textContent = waterCredits;
            }
        }
        
        // Hàm đặt lại cây
        function resetTree() {
            const pin = prompt("Nhập mã PIN để xác nhận đặt lại cây (****)");
            if (pin !== "2022") {
                alert("Mã PIN không đúng!");
                return;
            }
            
            if (confirm("Bạn có chắc chắn muốn đặt lại cây không? Cây sẽ trở về cấp độ 1.")) {
                treeLevel = 1;
                saveData();
                updateTreeDisplay();
                alert("Đã đặt lại cây thành công!");
            }
        }
        
        // Hàm kiểm tra và hiển thị thông báo nhiệm vụ
        function checkTaskNotifications() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTimeStr = `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`;
            
            // Kiểm tra các nhiệm vụ cho cả hai bé
            for (const childName in tasks) {
                const childTasks = tasks[childName];
                
                childTasks.forEach(task => {
                    // Nếu bây giờ là thời gian của nhiệm vụ (trong phạm vi 5 phút)
                    const taskHour = parseInt(task.time.split(':')[0]);
                    const taskMinute = parseInt(task.time.split(':')[1]);
                    
                    if (currentHour === taskHour && Math.abs(currentMinute - taskMinute) <= 5) {
                        // Kiểm tra xem nhiệm vụ đã được thông báo chưa
                        const notifiedTasks = JSON.parse(localStorage.getItem('notifiedTasks') || '{}');
                        const today = now.toISOString().split('T')[0];
                        
                        if (!notifiedTasks[today] || !notifiedTasks[today][`${childName}-${task.id}`]) {
                            // Hiển thị thông báo
                            const childDisplayName = childName === 'thaoVy' ? 'Thảo Vy' : 'Trí Dũng';
                            const notification = new Notification(`Nhiệm vụ cho bé ${childDisplayName}`, {
                                body: `Đã đến giờ: ${task.name} (${task.time})`,
                                icon: `images/${childName === 'thaoVy' ? 'vy.jpg' : 'vit.jpg'}`
                            });
                            
                            // Đánh dấu đã thông báo
                            if (!notifiedTasks[today]) notifiedTasks[today] = {};
                            notifiedTasks[today][`${childName}-${task.id}`] = true;
                            localStorage.setItem('notifiedTasks', JSON.stringify(notifiedTasks));
                            
                            // Phát âm thanh
                            if (task.audio) {
                                playAudio(task.audio);
                            }
                        }
                    }
                });
            }
        }
        
        // Yêu cầu quyền hiển thị thông báo
        function requestNotificationPermission() {
            if ('Notification' in window) {
                if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                    Notification.requestPermission().then(function(permission) {
                        if (permission === 'granted') {
                            new Notification("Thông báo đã được bật", {
                                body: "Bạn sẽ nhận được thông báo khi đến giờ thực hiện nhiệm vụ.",
                                icon: "images/vit.jpg"
                            });
                        }
                    });
                }
            }
        }
        
        // Kiểm tra huy hiệu
        function checkBadges(childName) {
            const today = new Date().toISOString().split('T')[0];
            
            const childData = JSON.parse(localStorage.getItem(`${childName}Data`) || '{}');
            if (!childData.tasks || !childData.tasks[today]) return;
            
            const todayTasks = childData.tasks[today];
            
            // Đếm số nhiệm vụ được hoàn thành tốt
            const goodTasks = Object.values(todayTasks).filter(rating => rating === 'good').length;
            const totalTasks = tasks[childName].length;
            
            // Nếu tất cả nhiệm vụ đều hoàn thành tốt
            if (goodTasks === totalTasks) {
                // Thêm thưởng đặc biệt
                addWaterCredits(2);
                
                // Hiển thị thông báo
                const childDisplayName = childName === 'thaoVy' ? 'Thảo Vy' : 'Trí Dũng';
                
                // Hiệu ứng pháo hoa
                setTimeout(() => {
                    triggerFireworks();
                    alert(`Tuyệt vời! Bé ${childDisplayName} đã hoàn thành tất cả nhiệm vụ hôm nay với mức "Tốt".\nBạn nhận được 2 lượt tưới nước đặc biệt!`);
                }, 1000);
            }
        }
        
        // Tạo hiệu ứng pháo hoa
        function triggerFireworks() {
            // Tạo container pháo hoa
            let fireworksContainer = document.createElement('div');
            fireworksContainer.id = 'fireworks-container';
            fireworksContainer.style.position = 'fixed';
            fireworksContainer.style.top = '0';
            fireworksContainer.style.left = '0';
            fireworksContainer.style.width = '100%';
            fireworksContainer.style.height = '100%';
            fireworksContainer.style.pointerEvents = 'none';
            fireworksContainer.style.zIndex = '9999';
            document.body.appendChild(fireworksContainer);
            
            // Tạo các màu pháo hoa ngẫu nhiên
            const colors = ['#FF5252', '#FF4081', '#E040FB', '#7C4DFF', '#536DFE', '#448AFF', '#40C4FF', '#18FFFF', '#64FFDA', '#69F0AE', '#B2FF59', '#EEFF41', '#FFFF00', '#FFD740', '#FFAB40', '#FF6E40'];
            
            // Tạo 20 pháo hoa
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    createFirework(fireworksContainer, colors);
                }, i * 300);
            }
            
            // Xóa container sau khi hoàn thành
            setTimeout(() => {
                fireworksContainer.remove();
            }, 7000);
        }
        
        // Tạo một pháo hoa
        function createFirework(container, colors) {
            const x = Math.random() * 100;
            const y = Math.random() * 60 + 20;
            const size = Math.random() * 5 + 3;
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            // Tạo pháo hoa
            const firework = document.createElement('div');
            firework.style.position = 'absolute';
            firework.style.left = `${x}%`;
            firework.style.top = `${y}%`;
            firework.style.width = `${size}px`;
            firework.style.height = `${size}px`;
            firework.style.borderRadius = '50%';
            firework.style.backgroundColor = color;
            firework.style.boxShadow = `0 0 ${size * 2}px ${size}px ${color}`;
            
            // Thêm animation
            firework.style.animation = 'explode 1s forwards';
            
            // Thêm keyframes nếu chưa có
            if (!document.getElementById('fireworks-animation')) {
                const style = document.createElement('style');
                style.id = 'fireworks-animation';
                style.innerHTML = `
                    @keyframes explode {
                        0% { transform: scale(0); opacity: 0; }
                        50% { transform: scale(1); opacity: 1; }
                        100% { transform: scale(1.5); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            container.appendChild(firework);
            
            // Tạo tia pháo hoa
            for (let i = 0; i < 8; i++) {
                const ray = document.createElement('div');
                const angle = (i / 8) * 360;
                const raySize = size * 0.8;
                
                ray.style.position = 'absolute';
                ray.style.width = `${raySize}px`;
                ray.style.height = `${raySize}px`;
                ray.style.borderRadius = '50%';
                ray.style.backgroundColor = color;
                ray.style.boxShadow = `0 0 ${raySize}px ${raySize / 2}px ${color}`;
                ray.style.left = `${x}%`;
                ray.style.top = `${y}%`;
                ray.style.animation = `fireworkRay${i} 0.8s forwards`;
                
                container.appendChild(ray);
                
                // Thêm keyframes cho tia
                if (!document.getElementById(`firework-ray-${i}`)) {
                    const rayStyle = document.createElement('style');
                    rayStyle.id = `firework-ray-${i}`;
                    const distance = 100 + Math.random() * 50;
                    rayStyle.innerHTML = `
                        @keyframes fireworkRay${i} {
                            0% { transform: translate(-50%, -50%) rotate(${angle}deg) translateX(0); opacity: 1; }
                            100% { transform: translate(-50%, -50%) rotate(${angle}deg) translateX(${distance}px); opacity: 0; }
                        }
                    `;
                    document.head.appendChild(rayStyle);
                }
            }
            
            // Xóa pháo hoa sau khi hiệu ứng kết thúc
            setTimeout(() => {
                firework.remove();
            }, 1000);
        }
        
        // Chuyển đổi hiển thị thống kê
        function toggleStatsView() {
            const statsContent = document.getElementById('stats-content');
            
            if (statsContent.style.display === 'none' || !statsContent.style.display) {
                statsContent.style.display = 'block';
                
                // Animation xoay biểu tượng
                const toggleBtn = document.querySelector('.stats-toggle-button i');
                toggleBtn.style.transition = 'transform 0.3s';
                toggleBtn.style.transform = 'rotate(180deg)';
                
                setTimeout(() => {
                    toggleBtn.style.transform = '';
                }, 300);
            } else {
                statsContent.style.display = 'none';
            }
            
            // Cập nhật hiển thị thống kê
            updateStatsDisplay();
        }
        
        // Biến lưu trữ ngày hiện tại đang xem
        let viewDate = new Date();
        let dateOffset = 0; // Offset từ ngày hiện tại

        // Hàm điều hướng ngày để xem/sửa dữ liệu ngày khác
        function navigateDate(offset) {
            dateOffset += offset;
            // Giới hạn chỉ xem trong phạm vi ±7 ngày
            if (dateOffset < -7) dateOffset = -7;
            if (dateOffset > 7) dateOffset = 7;
            
            // Tính ngày mới
            viewDate = new Date();
            viewDate.setDate(viewDate.getDate() + dateOffset);
            
            // Cập nhật hiển thị ngày và dữ liệu
            updateViewDateDisplay();
            updateTaskDisplay();
        }
        
        // Cập nhật hiển thị ngày đang xem
        function updateViewDateDisplay() {
            const options = { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'numeric', 
                year: 'numeric'
            };
            
            // Định dạng ngày
            let dateString = viewDate.toLocaleDateString('vi-VN', options);
            dateString = dateString.charAt(0).toUpperCase() + dateString.slice(1);
            
            // Thêm thông tin thời gian
            const timeString = viewDate.toLocaleTimeString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Đánh dấu nếu đang xem ngày khác với hôm nay
            let displayText = `${timeString}, ${dateString}`;
            if (dateOffset !== 0) {
                const dayWord = dateOffset < 0 ? "trước" : "sau";
                const absDays = Math.abs(dateOffset);
                displayText += ` (${absDays} ngày ${dayWord})`;
            }
            
            // Cập nhật hiển thị
            document.querySelector('.current-time').textContent = displayText;
        }
        
        // Biến lưu trữ thử thách tuần
        let weeklyChallenge = {
            target: 3,
            progress: 0,
            taskType: 'di_ngu',  // ID của nhiệm vụ đi ngủ
            completed: false
        };
        
        // Cập nhật tiến độ thử thách tuần
        function updateWeeklyChallengeProgress() {
            // Tải dữ liệu thử thách từ localStorage
            const savedChallenge = localStorage.getItem('weeklyChallenge');
            if (savedChallenge) {
                weeklyChallenge = JSON.parse(savedChallenge);
            }
            
            // Nếu thử thách đã hoàn thành, chỉ cập nhật hiển thị
            if (weeklyChallenge.completed) {
                document.getElementById('challenge-progress-fill').style.width = '100%';
                document.getElementById('challenge-progress-text').textContent = `${weeklyChallenge.target}/${weeklyChallenge.target}`;
                return;
            }
            
            // Tính tiến độ nhiệm vụ đi ngủ đã hoàn thành tốt
            let progress = 0;
            
            // Kiểm tra nhiệm vụ ngủ trong cả dữ liệu của Trí Dũng và Thảo Vy
            const children = ['tridung', 'thaoVy'];
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            // ID nhiệm vụ đi ngủ
            const sleepTaskIds = {
                'tridung': 'td6',  // ID nhiệm vụ đi ngủ của Trí Dũng
                'thaoVy': 'tv6'    // ID nhiệm vụ đi ngủ của Thảo Vy
            };
            
            // Kiểm tra dữ liệu trong khoảng 7 ngày gần đây
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 6);
            
            // Duyệt qua từng ngày trong 7 ngày gần đây
            for (let d = new Date(startDate); d <= now; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                
                // Kiểm tra dữ liệu của mỗi bé
                children.forEach(child => {
                    const childData = JSON.parse(localStorage.getItem(`${child}Data`) || '{}');
                    if (childData.tasks && childData.tasks[dateStr]) {
                        // Kiểm tra nhiệm vụ đi ngủ
                        const sleepTask = childData.tasks[dateStr][sleepTaskIds[child]];
                        if (sleepTask === 'good') {
                            progress++;
                        }
                    }
                });
            }
            
            // Giới hạn tiến độ không vượt quá mục tiêu
            if (progress > weeklyChallenge.target) {
                progress = weeklyChallenge.target;
            }
            
            // Cập nhật biến thử thách
            weeklyChallenge.progress = progress;
            
            // Kiểm tra hoàn thành
            if (progress >= weeklyChallenge.target) {
                weeklyChallenge.completed = true;
                completeWeeklyChallenge();
            }
            
            // Lưu thử thách
            localStorage.setItem('weeklyChallenge', JSON.stringify(weeklyChallenge));
            
            // Cập nhật hiển thị
            const progressPercentage = (progress / weeklyChallenge.target) * 100;
            document.getElementById('challenge-progress-fill').style.width = `${progressPercentage}%`;
            document.getElementById('challenge-progress-text').textContent = `${progress}/${weeklyChallenge.target}`;
        }
        
        // Hoàn thành thử thách tuần
        function completeWeeklyChallenge() {
            // Thêm phần thưởng
            addWaterCredits(2);
            
            // Hiệu ứng
            setTimeout(() => {
                triggerFireworks();
                playAudio('firework.mp3');
                
                // Thông báo
                alert("Chúc mừng! Bé đã hoàn thành thử thách tuần này và nhận được 2 lượt tưới nước đặc biệt!");
            }, 1000);
        }
        
        // Đặt lại thử thách tuần
        function resetWeeklyChallenge() {
            // Kiểm tra xác nhận
            const pin = prompt("Nhập mã PIN để xác nhận đặt lại thử thách (****)");
            if (pin !== "2022") {
                alert("Mã PIN không đúng!");
                return;
            }
            
            if (confirm("Bạn có chắc chắn muốn đặt lại thử thách tuần không?")) {
                weeklyChallenge = {
                    target: 3,
                    progress: 0,
                    taskType: 'di_ngu',
                    completed: false
                };
                
                // Lưu thử thách mới
                localStorage.setItem('weeklyChallenge', JSON.stringify(weeklyChallenge));
                
                // Cập nhật hiển thị
                updateWeeklyChallengeProgress();
                
                alert("Đã đặt lại thử thách tuần thành công!");
            }
        }
        
        // Biến lưu trữ điểm thi đua tuần này
        let competitionScores = {
            tridung: 0,
            thaoVy: 0
        };
        
        // Cập nhật điểm thi đua
        function updateCompetitionScores(childName, rating) {
            // Tải điểm hiện tại
            loadCompetitionScores();
            
            // Cộng điểm dựa trên đánh giá
            if (rating === 'good') {
                competitionScores[childName] += 2; // 2 điểm cho đánh giá tốt
            } else if (rating === 'neutral') {
                competitionScores[childName] += 1; // 1 điểm cho đánh giá chấp nhận được
            }
            
            // Lưu điểm
            saveCompetitionScores();
            
            // Cập nhật hiển thị
            updateCompetitionDisplay();
        }
        
        // Lưu điểm thi đua
        function saveCompetitionScores() {
            localStorage.setItem('competitionScores', JSON.stringify(competitionScores));
        }
        
        // Tải điểm thi đua
        function loadCompetitionScores() {
            const savedScores = localStorage.getItem('competitionScores');
            if (savedScores) {
                competitionScores = JSON.parse(savedScores);
            } else {
                competitionScores = {
                    tridung: 0,
                    thaoVy: 0
                };
            }
        }
        
        // Cập nhật hiển thị điểm thi đua
        function updateCompetitionDisplay() {
            // Hiển thị điểm
            document.getElementById('competition-tridung-score').textContent = competitionScores.tridung;
            document.getElementById('competition-thaoVy-score').textContent = competitionScores.thaoVy;
            
            // Cập nhật cấp độ hiển thị
            const tridungData = JSON.parse(localStorage.getItem('tridungData') || '{}');
            const thaoVyData = JSON.parse(localStorage.getItem('thaoVyData') || '{}');
            
            const tridungLevel = calculateLevel(tridungData.points || 0);
            const thaoVyLevel = calculateLevel(thaoVyData.points || 0);
            
            document.getElementById('competition-tridung-level').textContent = tridungLevel;
            document.getElementById('competition-thaoVy-level').textContent = thaoVyLevel;
            
            // Cập nhật thanh điểm
            const maxScore = Math.max(competitionScores.tridung, competitionScores.thaoVy, 10);
            document.getElementById('competition-tridung-bar').style.width = `${(competitionScores.tridung / maxScore) * 100}%`;
            document.getElementById('competition-thaoVy-bar').style.width = `${(competitionScores.thaoVy / maxScore) * 100}%`;
        }
        
        // Đặt lại điểm thi đua
        function resetCompetitionScores() {
            // Kiểm tra xác nhận
            const pin = prompt("Nhập mã PIN để xác nhận đặt lại điểm thi đua (****)");
            if (pin !== "2022") {
                alert("Mã PIN không đúng!");
                return;
            }
            
            if (confirm("Bạn có chắc chắn muốn đặt lại điểm thi đua tuần này không?")) {
                competitionScores = {
                    tridung: 0,
                    thaoVy: 0
                };
                saveCompetitionScores();
                updateCompetitionDisplay();
                alert("Đã đặt lại điểm thi đua tuần thành công!");
            }
        }
        
        // Tạo hiệu ứng pháo hoa
        function createFireworks() {
            // Tạo container pháo hoa
            let fireworksContainer = document.createElement('div');
            fireworksContainer.id = 'fireworks-container';
            fireworksContainer.style.position = 'fixed';
            fireworksContainer.style.top = '0';
            fireworksContainer.style.left = '0';
            fireworksContainer.style.width = '100%';
            fireworksContainer.style.height = '100%';
            fireworksContainer.style.pointerEvents = 'none';
            fireworksContainer.style.zIndex = '9999';
            document.body.appendChild(fireworksContainer);
            
            // Tạo các màu pháo hoa ngẫu nhiên
            const colors = ['#FF5252', '#FF4081', '#E040FB', '#7C4DFF', '#536DFE', '#448AFF', '#40C4FF', '#18FFFF', '#64FFDA', '#69F0AE', '#B2FF59', '#EEFF41', '#FFFF00', '#FFD740', '#FFAB40', '#FF6E40'];
            
            // Tạo nhiều pháo hoa với các vị trí khác nhau
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    createFirework(fireworksContainer, colors);
                }, i * 100);
            }
            
            // Xóa container sau 3 giây
            setTimeout(() => {
                fireworksContainer.remove();
            }, 3000);
        }
        
        // Tạo một pháo hoa
        function createFirework(container, colors) {
            const x = Math.random() * 100;
            const y = Math.random() * 60 + 20;
            const size = Math.random() * 5 + 3;
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            // Tạo pháo hoa
            const firework = document.createElement('div');
            firework.style.position = 'absolute';
            firework.style.left = `${x}%`;
            firework.style.top = `${y}%`;
            firework.style.width = `${size}px`;
            firework.style.height = `${size}px`;
            firework.style.borderRadius = '50%';
            firework.style.backgroundColor = color;
            firework.style.boxShadow = `0 0 ${size * 2}px ${size}px ${color}`;
            
            // Thêm animation
            firework.style.animation = 'explode 1s forwards';
            
            // Thêm keyframes nếu chưa có
            if (!document.getElementById('fireworks-animation')) {
                const style = document.createElement('style');
                style.id = 'fireworks-animation';
                style.innerHTML = `
                    @keyframes explode {
                        0% { transform: scale(0); opacity: 0; }
                        50% { transform: scale(1); opacity: 1; }
                        100% { transform: scale(1.5); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            container.appendChild(firework);
            
            // Tạo tia pháo hoa
            for (let i = 0; i < 12; i++) {
                const ray = document.createElement('div');
                const angle = (i / 12) * 360;
                const raySize = size * 0.8;
                
                ray.style.position = 'absolute';
                ray.style.width = `${raySize}px`;
                ray.style.height = `${raySize}px`;
                ray.style.borderRadius = '50%';
                ray.style.backgroundColor = color;
                ray.style.boxShadow = `0 0 ${raySize}px ${raySize / 2}px ${color}`;
                ray.style.left = `${x}%`;
                ray.style.top = `${y}%`;
                ray.style.animation = `fireworkRay${i} 0.8s forwards`;
                
                container.appendChild(ray);
                
                // Thêm keyframes cho tia
                if (!document.getElementById(`firework-ray-${i}`)) {
                    const rayStyle = document.createElement('style');
                    rayStyle.id = `firework-ray-${i}`;
                    const distance = 100 + Math.random() * 50;
                    rayStyle.innerHTML = `
                        @keyframes fireworkRay${i} {
                            0% { transform: translate(-50%, -50%) rotate(${angle}deg) translateX(0); opacity: 1; }
                            100% { transform: translate(-50%, -50%) rotate(${angle}deg) translateX(${distance}px); opacity: 0; }
                        }
                    `;
                    document.head.appendChild(rayStyle);
                }
            }
            
            // Xóa pháo hoa sau khi hiệu ứng kết thúc
            setTimeout(() => {
                firework.remove();
            }, 1000);
        }
    </script>
</body>
</html>
