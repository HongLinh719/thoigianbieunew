<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Thời gian biểu cho bé</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&display=swap" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
    <link href="css/main.css" rel="stylesheet"/>
    <script type="module">
        import { CONFIG } from './js/config.js';
        import { DataService } from './js/data.js';
        import { UI } from './js/ui.js';
        import './components/profile.js';
        import './components/task.js';

        // Khởi tạo ứng dụng khi tài liệu đã sẵn sàng
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                currentChild: 'tridung',
                
                init() {
                    this.setupEventListeners();
                    this.loadInitialData();
                    this.updateDisplay();
                },

                setupEventListeners() {
                    // Xử lý chuyển đổi tab
                    document.querySelectorAll('.tab').forEach(tab => {
                        tab.addEventListener('click', (e) => {
                            const childName = e.currentTarget.dataset.child;
                            this.switchChild(childName);
                        });
                    });

                    // Xử lý đánh giá nhiệm vụ
                    document.addEventListener('rate-task', (e) => {
                        const { taskId, rating } = e.detail;
                        this.rateTask(taskId, rating);
                    });
                },

                loadInitialData() {
                    const data = DataService.load();
                    if (!data.tridung || !data.thaoVy) {
                        // Khởi tạo dữ liệu mặc định
                        DataService.save({
                            tridung: { tasks: [], level: 1, experience: 0 },
                            thaoVy: { tasks: [], level: 1, experience: 0 }
                        });
                    }
                },

                updateDisplay() {
                    UI.updateTaskDisplay(this.currentChild);
                    UI.updateLevelDisplay(this.currentChild);
                },

                switchChild(childName) {
                    this.currentChild = childName;
                    document.querySelectorAll('.tab').forEach(tab => {
                        tab.classList.toggle('active', tab.dataset.child === childName);
                    });
                    document.querySelectorAll('.child-content').forEach(content => {
                        content.style.display = content.id === childName ? 'block' : 'none';
                    });
                    this.updateDisplay();
                },

                async rateTask(taskId, rating) {
                    const pin = prompt('Nhập mã PIN để xác nhận (****)');
                    if (pin !== CONFIG.PIN) {
                        UI.showNotification('Mã PIN không đúng!', 'error');
                        return;
                    }

                    const data = DataService.getChildProgress(this.currentChild);
                    const task = data.tasks.find(t => t.id === taskId);
                    if (task) {
                        task.rating = rating;
                        DataService.saveChildProgress(this.currentChild, data);
                        this.updateDisplay();
                        
                        if (rating === 'good') {
                            const audio = new Audio(CONFIG.AUDIO_PATHS.goodTask);
                            await audio.play();
                            UI.showNotification('Tuyệt vời! Bé đã hoàn thành tốt nhiệm vụ!', 'success');
                        }
                    }
                }
            };

            // Khởi chạy ứng dụng
            app.init();
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Thời gian biểu cho bé</h1>
        </div>

        <div class="tabs">
            <div class="tab active" data-child="tridung">
                <img src="images/vit.jpg" alt="Trí Dũng">
                Trí Dũng (5 tuổi)
            </div>
            <div class="tab" data-child="thaoVy">
                <img src="images/vy.jpg" alt="Thảo Vy">
                Thảo Vy (3 tuổi)
            </div>
        </div>

        <div id="tridung" class="child-content">
            <child-profile child-name="tridung"></child-profile>
            <div class="task-list"></div>
        </div>

        <div id="thaoVy" class="child-content" style="display: none;">
            <child-profile child-name="thaoVy"></child-profile>
            <div class="task-list"></div>
        </div>
    </div>
</body>
</html>